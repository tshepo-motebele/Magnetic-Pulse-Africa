@Html.AntiForgeryToken()
@model MagneticPulseAfrica.Models.DashboardViewModel 
@{
    ViewData["Title"] = "Admin Dashboard";
}

<!DOCTYPE html>
<div class="container-fluid py-4">
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">
            @TempData["ErrorMessage"]
        </div>
    }
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    <div class="row mb-4">
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="text-muted mb-2">Total Bookings</h5>
                            <h2 class="mb-0" id="totalBookings">@Model.Stats.TotalBookings</h2>
                        </div>
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px">
                            <i class="fas fa-calendar-check text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="text-muted mb-2">Total Reviews</h5>
                            <h2 class="mb-0" id="totalReviews">@Model.Stats.TotalReviews</h2>
                        </div>
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px">
                            <i class="fas fa-star text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="text-muted mb-2">Pending Bookings</h5>
                            <h2 class="mb-0" id="pendingBookings">@Model.Stats.PendingBookings</h2>
                        </div>
                        <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px">
                            <i class="fas fa-clock text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="text-muted mb-2">Average Rating</h5>
                            <h2 class="mb-0" id="avgRating">@Model.Stats.AverageRating.ToString("F1")</h2>
                        </div>
                        <div class="bg-info rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px">
                            <i class="fas fa-star-half-alt text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="bookings-tab" data-bs-toggle="tab" href="#bookings" role="tab">Bookings</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="reviews-tab" data-bs-toggle="tab" href="#reviews" role="tab">Reviews</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="bookings" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Recent Bookings</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Customer Name</th>
                                    <th>Booking Date</th>
                                    <th>Status</th>
                                    <th>Reason</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var booking in Model.Consultations)
                                {
                                    <tr data-booking-id="@booking.Id">
                                        <td>@booking.Id</td>
                                        <td>@booking.FirstName @booking.LastName</td>
                                        <td>@booking.BookingDate.ToString("MMM dd, yyyy HH:mm")</td>
                                        <td>
                                            <span class="badge status-badge @(booking.Status switch {
            BookingStatus.Pending => "bg-warning",
            BookingStatus.Confirmed => "bg-primary",
            BookingStatus.Completed => "bg-success",
            BookingStatus.Cancelled => "bg-danger",
            BookingStatus.Rescheduled => "bg-info",
            _ => "bg-secondary"
        })">@booking.Status</span>
                                        </td>
                                        <td>@(booking.ConsultationReason?.Length > 50 ? booking.ConsultationReason.Substring(0, 47) + "..." : booking.ConsultationReason)</td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="@Url.Action("Details", new { id = booking.Id })"
                                                   class="btn btn-sm btn-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button class="btn btn-sm btn-info" onclick="updateStatus('@booking.Id')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                @if (booking.Status != BookingStatus.Cancelled)
                                                {
                                                    using (Html.BeginForm("Delete", "Admin", FormMethod.Post))
                                                    {
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="id" value="@booking.Id" />
                                                        <button type="submit" class="btn btn-sm btn-danger"
                                                                onclick="return confirm('Are you sure you want to delete this booking?');">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    }
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="reviews" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Customer Reviews</h4>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="reviewFilter">
                                <option value="all">All Ratings</option>
                                <option value="5">5 Stars</option>
                                <option value="4">4 Stars</option>
                                <option value="3">3 Stars</option>
                                <option value="2">2 Stars</option>
                                <option value="1">1 Star</option>
                            </select>
                            <button class="btn btn-primary" id="exportReviews">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                        </div>
                    </div>
                    <div id="reviewsList" class="row g-4">
                        @foreach (var review in Model.Testimonials)
                        {
                            <div class="col-md-6 col-lg-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="card-title mb-0">@review.Name</h5>
                                            <div class="text-warning">
                                                @for (var i = 0; i < review.Rating; i++)
                                                {
                                                    <i class="fas fa-star"></i>
                                                }
                                            </div>
                                        </div>
                                        <p class="card-text">@review.TestimonialText</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">@review.CreatedAt.ToString("MMM dd, yyyy")</small>
                                            <a href="@Url.Action("TestimonialDetails", "Admin", new { id = review.Id })"
                                               class="btn btn-sm btn-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" id="dateRange">
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="all">All time</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="exportBtn">Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Sign Out Button -->
<div class="position-fixed bottom-0 end-0 p-4">
    <a asp-action="LogOut" class="btn btn-danger">
        <i class="fas fa-sign-out-alt me-2"></i>Sign Out
    </a>
</div>
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Booking Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="bookingId" name="id" />
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="bookingStatus" name="status">
                            <option value="0">Pending</option>
                            <option value="1">Confirmed</option>
                            <option value="2">Completed</option>
                            <option value="3">Cancelled</option>
                            <option value="4">Rescheduled</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateStatusBtn">Update Status</button>
            </div>
        </div>
    </div>
</div>
}
<style>
    .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .nav-tabs .nav-link {
        font-weight: 500;
    }

    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }

    .btn-group {
        gap: 0.25rem;
    }

    .badge {
        padding: 0.5em 1em;
        font-weight: 500;
    }
</style>
<script>
    function updateStatus(bookingId) {
        $('#bookingId').val(bookingId);
        $('#updateStatusModal').modal('show');
    }

    $('#updateStatusBtn').click(function () {
        var form = $('#updateStatusForm');
        var token = $('input[name="__RequestVerificationToken"]', form).val();
        var statusSelect = $('#bookingStatus');

        $.ajax({
            url: '/Admin/UpdateStatus',
            type: 'POST',
            data: {
                id: $('#bookingId').val(),
                status: statusSelect.val(),
                __RequestVerificationToken: token
            },
            success: function (response) {
                if (response.success) {
                    // Update status badge in the table or details view
                    var statusBadge = $(`tr[data-booking-id="${$('#bookingId').val()}"] .status-badge`);
                    if (statusBadge.length === 0) {
                        // We're on the details page
                        statusBadge = $('.status-badge');
                    }

                    statusBadge.text(response.newStatus);
                    statusBadge.removeClass().addClass(`badge status-badge ${response.statusClass}`);

                    // Update last updated timestamp if it exists
                    if (response.lastUpdated) {
                        $('[data-field="lastUpdated"]').text(response.lastUpdated);
                    }

                    // Show success message
                    toastr.success(response.message);

                    // Close modal
                    $('#updateStatusModal').modal('hide');

                    // If we're in the index view, you might want to refresh the stats
                    if ($('#totalBookings').length > 0) {
                        location.reload(); // Optional: refresh the page to update stats
                    }
                } else {
                    toastr.error(response.message);
                }
            },
            error: function () {
                toastr.error('An error occurred while updating the status.');
            }
        });
    });
</script>